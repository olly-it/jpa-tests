<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>JPA Tests</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 760px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.5rem; }
    form { margin: 1.5rem 0; display: flex; gap: .5rem; }
    input { flex: 1; padding: .5rem; }
    button { padding: .5rem 1rem; }
    #notes { margin-top: .75rem; width: 100%; border-collapse: collapse; }
    #notes th, #notes td { border-bottom: 1px solid #eee; padding: .4rem; text-align: left; }
    small { color: #666; }
    .swatch { width: 16px; height: 16px; display: inline-block; border: 1px solid #ccc; border-radius: 3px; }
    .swatch-empty { background: repeating-linear-gradient(45deg, #f5f5f5 0, #f5f5f5 6px, #ddd 6px, #ddd 12px); }
    .combo { position: relative; display: inline-block; }
    .combo-trigger { padding: .3rem .6rem; border: 1px solid #ccc; border-radius: 4px; background: repeating-linear-gradient(45deg, #f5f5f5 0, #f5f5f5 6px, #ddd 6px, #ddd 12px); }
    .combo-menu { position: absolute; top: 100%; left: 0; margin-top: .25rem; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,.08); padding: .4rem; display: none; z-index: 1000; }
    .combo-items { display: grid; grid-template-columns: repeat(6, 24px); gap: .3rem; }
    .combo-item { width: 24px; height: 24px; border: 1px solid #ccc; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Note</h1>

  <form id="createForm">
    <input id="text" type="text" placeholder="Scrivi una nota" required />
    <div id="color-combo-main" class="combo"></div>
    <button type="submit">Aggiungi</button>
  </form>

  <table id="notes">
    <thead>
      <tr>
        <th>Nota</th>
        <th></th>
        <th></th>
        <th>Elimina</th>
        <th>Colore</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const notesTable = document.getElementById('notes');
    const notesBody = notesTable.querySelector('tbody');
    const formEl = document.getElementById('createForm');
    const inputEl = document.getElementById('text');
    let selectedColor = null;
    const palette = ['','#ff5555','#55ff55','#5555ff','#ffaa00','#aaaaaa'];
    function createColorCombo(root, initialColor, onChange) {
      const trigger = document.createElement('button');
      trigger.type = 'button';
      trigger.className = 'combo-trigger';
      const menu = document.createElement('div');
      menu.className = 'combo-menu';
      const items = document.createElement('div');
      items.className = 'combo-items';
      menu.appendChild(items);
      function setTriggerColor(c) {
        if (!c) { trigger.style.background = 'repeating-linear-gradient(45deg, #f5f5f5 0, #f5f5f5 6px, #ddd 6px, #ddd 12px)'; trigger.style.color = '#000'; }
        else { trigger.style.background = c; trigger.style.color = '#fff'; }
      }
      for (const c of palette) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'combo-item';
        if (!c) btn.classList.add('swatch-empty'); else btn.style.background = c;
        btn.onclick = () => { setTriggerColor(c); menu.style.display = 'none'; onChange(c || null); };
        items.appendChild(btn);
      }
      setTriggerColor(initialColor);
      trigger.onclick = (e) => { e.preventDefault(); e.stopPropagation(); menu.style.display = menu.style.display === 'none' || menu.style.display === '' ? 'block' : 'none'; };
      document.addEventListener('click', () => { menu.style.display = 'none'; });
      root.appendChild(trigger);
      root.appendChild(menu);
    }
    const comboMain = document.getElementById('color-combo-main');
    createColorCombo(comboMain, null, (c) => { selectedColor = c; });

    async function load() {
      const res = await fetch('/api/notes');
      const notes = await res.json();
      notesBody.innerHTML = '';
      for (const n of notes) {
        const tr = document.createElement('tr');
        const tdNota = document.createElement('td');
        const tdColore = document.createElement('td');
        const tdInfo = document.createElement('td');
        const tdElimina = document.createElement('td');
        const tdSetColore = document.createElement('td');

        const span = document.createElement('span');
        span.textContent = n.text;
        tdNota.appendChild(span);

        const colorSwatch = document.createElement('span');
        colorSwatch.className = 'swatch' + (n.noteColor?.color ? '' : ' swatch-empty');
        if (n.noteColor?.color) colorSwatch.style.background = n.noteColor.color;
        colorSwatch.title = n.noteColor?.color ? n.noteColor.color : 'Colore non impostato';
        tdColore.appendChild(colorSwatch);

        const small = document.createElement('small');
        small.textContent = `#${n.id} Â· ${n.createdAt}`;
        tdInfo.appendChild(small);

        const del = document.createElement('button');
        del.textContent = 'Elimina';
        del.onclick = async () => {
          await fetch(`/api/notes/${n.id}`, { method: 'DELETE' });
          await load();
        };
        tdElimina.appendChild(del);

        const combo = document.createElement('div');
        combo.className = 'combo';
        tdSetColore.appendChild(combo);
        function onRowColorChange(val) {
          fetch(`/api/notes/${n.id}/color`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ color: val })
          }).then(() => load());
        }
        createColorCombo(combo, n.noteColor?.color || null, onRowColorChange);

        tr.appendChild(tdNota);
        tr.appendChild(tdColore);
        tr.appendChild(tdInfo);
        tr.appendChild(tdElimina);
        tr.appendChild(tdSetColore);
        notesBody.appendChild(tr);
      }
    }

    formEl.onsubmit = async (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      if (!text) return;
      const payload = { text };
      if (selectedColor) payload.color = selectedColor; else payload.color = null;
      await fetch('/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      inputEl.value = '';
      selectedColor = null;
      await load();
    };

    load();
  </script>
</body>
</html>
