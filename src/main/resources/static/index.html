<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>JPA Tests</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 760px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.5rem; }
    form { margin: 1.5rem 0; display: flex; gap: .5rem; }
    input { flex: 1; padding: .5rem; }
    button { padding: .5rem 1rem; }
    #list { margin-top: .75rem; }
    ul { list-style: none; padding: 0; }
    li { padding: .4rem 0; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: .5rem; }
    small { color: #666; }
    .swatch { width: 16px; height: 16px; display: inline-block; border: 1px solid #ccc; border-radius: 3px; }
    .swatch-empty { background: repeating-linear-gradient(45deg, #f5f5f5 0, #f5f5f5 6px, #ddd 6px, #ddd 12px); }
  </style>
</head>
<body>
  <h1>Note</h1>

  <form id="createForm">
    <input id="text" type="text" placeholder="Scrivi una nota" required />
    <input id="color" type="color" value="#000000" title="Colore (opzionale)" />
    <button id="colorBtn" type="button">---</button>
    <button type="submit">Aggiungi</button>
  </form>

  <ul id="list"></ul>

  <script>
    const listEl = document.getElementById('list');
    const formEl = document.getElementById('createForm');
    const inputEl = document.getElementById('text');
    const colorEl = document.getElementById('color');
    const colorBtnMain = document.getElementById('colorBtn');
    colorEl.style.opacity = '0';
    colorEl.style.width = '0';
    colorEl.style.height = '0';
    if (colorEl.value && colorEl.value !== '#000000') {
      colorBtnMain.style.background = colorEl.value;
      colorBtnMain.style.color = '#fff';
    } else {
      colorBtnMain.style.background = 'repeating-linear-gradient(45deg, #f5f5f5 0, #f5f5f5 6px, #ddd 6px, #ddd 12px)';
    }
    colorBtnMain.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (typeof colorEl.showPicker === 'function') {
        colorEl.showPicker();
      } else {
        const prev = {
          opacity: colorEl.style.opacity,
          width: colorEl.style.width,
          height: colorEl.style.height,
          position: colorEl.style.position,
          left: colorEl.style.left,
          top: colorEl.style.top,
          zIndex: colorEl.style.zIndex,
        };
        colorEl.style.opacity = '1';
        colorEl.style.width = '1px';
        colorEl.style.height = '1px';
        colorEl.style.position = 'fixed';
        colorEl.style.left = '50%';
        colorEl.style.top = '50%';
        colorEl.style.zIndex = '9999';
        colorEl.click();
        const restore = () => {
          colorEl.style.opacity = prev.opacity;
          colorEl.style.width = prev.width;
          colorEl.style.height = prev.height;
          colorEl.style.position = prev.position;
          colorEl.style.left = prev.left;
          colorEl.style.top = prev.top;
          colorEl.style.zIndex = prev.zIndex;
          colorEl.removeEventListener('blur', restore);
          colorEl.removeEventListener('change', restore);
        };
        colorEl.addEventListener('blur', restore);
        colorEl.addEventListener('change', restore);
      }
    };
    colorEl.addEventListener('input', () => {
      colorBtnMain.style.background = colorEl.value;
      colorBtnMain.style.color = '#fff';
    });
    colorEl.addEventListener('change', () => {
      colorBtnMain.style.background = colorEl.value;
      colorBtnMain.style.color = '#fff';
    });

    async function load() {
      const res = await fetch('/api/notes');
      const notes = await res.json();
      listEl.innerHTML = '';
      for (const n of notes) {
        const li = document.createElement('li');
        const span = document.createElement('span');
        span.textContent = n.text;
        const small = document.createElement('small');
        const colorSwatch = document.createElement('span');
        colorSwatch.className = 'swatch' + (n.noteColor?.color ? '' : ' swatch-empty');
        if (n.noteColor?.color) colorSwatch.style.background = n.noteColor.color;
        colorSwatch.title = n.noteColor?.color ? n.noteColor.color : 'Colore non impostato';
        small.textContent = `#${n.id} Â· ${n.createdAt}`;
        const del = document.createElement('button');
        del.textContent = 'Elimina';
        del.onclick = async () => {
          await fetch(`/api/notes/${n.id}`, { method: 'DELETE' });
          await load();
        };
        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.value = n.noteColor?.color || '#000000';
        colorInput.style.opacity = '0';
        colorInput.style.width = '0';
        colorInput.style.height = '0';
        const colorBtn = document.createElement('button');
        colorBtn.type = 'button';
        colorBtn.textContent = '---';
        if (n.noteColor?.color) {
          colorBtn.style.background = n.noteColor.color;
          colorBtn.style.color = '#fff';
        } else {
          colorBtn.style.background = 'repeating-linear-gradient(45deg, #f5f5f5 0, #f5f5f5 6px, #ddd 6px, #ddd 12px)';
        }
        colorBtn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (typeof colorInput.showPicker === 'function') {
            colorInput.showPicker();
          } else {
            const prev = {
              opacity: colorInput.style.opacity,
              width: colorInput.style.width,
              height: colorInput.style.height,
              position: colorInput.style.position,
              left: colorInput.style.left,
              top: colorInput.style.top,
              zIndex: colorInput.style.zIndex,
            };
            colorInput.style.opacity = '1';
            colorInput.style.width = '1px';
            colorInput.style.height = '1px';
            colorInput.style.position = 'fixed';
            colorInput.style.left = '50%';
            colorInput.style.top = '50%';
            colorInput.style.zIndex = '9999';
            colorInput.click();
            const restore = () => {
              colorInput.style.opacity = prev.opacity;
              colorInput.style.width = prev.width;
              colorInput.style.height = prev.height;
              colorInput.style.position = prev.position;
              colorInput.style.left = prev.left;
              colorInput.style.top = prev.top;
              colorInput.style.zIndex = prev.zIndex;
              colorInput.removeEventListener('blur', restore);
              colorInput.removeEventListener('change', restore);
            };
            colorInput.addEventListener('blur', restore);
            colorInput.addEventListener('change', restore);
          }
        };
        colorInput.addEventListener('input', () => {
          colorBtn.style.background = colorInput.value;
          colorBtn.style.color = '#fff';
        });
        colorInput.addEventListener('change', () => {
          colorBtn.style.background = colorInput.value;
          colorBtn.style.color = '#fff';
        });
        const setColorBtn = document.createElement('button');
        setColorBtn.type = 'button';
        setColorBtn.textContent = 'Imposta colore';
        setColorBtn.onclick = async () => {
          await fetch(`/api/notes/${n.id}/color`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ color: colorInput.value })
          });
          await load();
        };
        li.appendChild(span);
        li.appendChild(colorSwatch);
        li.appendChild(small);
        li.appendChild(del);
        li.appendChild(colorBtn);
        li.appendChild(colorInput);
        li.appendChild(setColorBtn);
        listEl.appendChild(li);
      }
    }

    formEl.onsubmit = async (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      if (!text) return;
      const payload = { text };
      const clr = colorEl.value;
      if (clr && clr !== '#000000') payload.color = clr;
      await fetch('/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      inputEl.value = '';
      colorEl.value = '#000000';
      colorBtnMain.style.background = 'repeating-linear-gradient(45deg, #f5f5f5 0, #f5f5f5 6px, #ddd 6px, #ddd 12px)';
      await load();
    };

    load();
  </script>
</body>
</html>
